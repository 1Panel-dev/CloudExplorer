# CloudExplorer开发指南


## 目录

- [环境准备](#环境准备)
  - [前端环境](#前端环境)
  - [后端环境](#后端环境)
- [开发](#开发)
  - [接口基本调用参数](#接口基本调用参数)
  - [后端权限](#后端权限)
  - [前端权限](#前端权限)
  - [新模块搭建](#新模块搭建)
  


## 环境准备

### 前端环境

- 安装 [node](https://nodejs.org/)
- 启用 corepack
  - Node.js >=16.10

    ```bash
    corepack enable
    ```
  - Node.js <16.10

    ```bash
    npm i -g corepack
    ```


### 后端环境
- 安装 [JDK17](https://www.oracle.com/java/technologies/javase/jdk17-archive-downloads.html)
- 安装 [Maven](https://maven.apache.org/download.cgi)
- 安装 [Docker](https://www.docker.com/)


## 开发
### VmWare相关依赖
请在项目根目录执行
``` bash
mvn initialize
```

### 接口基本调用参数

调用登录以及任意需要认证的接口，在response的header内均会返回当前用户的 JWT token：`CE-TOKEN`


后端调用接口需要以下header：
```
CE-TOKEN:  登录获取到的 JWT token
CE-ROLE:   角色(ADMIN,ORGADMIN,USER)
CE-SOURCE: 组织/工作空间id（ADMIN角色不传）
```
若`CE-ROLE`和`CE-SOURCE`与当前用户不匹配，后端认为就是`ANONYMOUS`角色。


### 后端权限

***1. 模块基础权限***

模块内基础权限配置，在每个模块内的`PermissionConstants.java`中配置`MODULE_PERMISSION_BUILDER`

```java
private static final ModulePermission.Builder MODULE_PERMISSION_BUILDER = new ModulePermission.Builder()
            .group(
                    //用户管理
                    new PermissionGroup.Builder()
                            .id(GROUP.USER)    //权限组
                            .name("i18n_permission_user")
                            .permission(
                                    //查看用户
                                    new Permission.Builder()
                                            .operate(OPERATE.READ)    //权限操作
                                            .name("i18n_permission_user_read")
                                            .role(RoleConstants.ROLE.ADMIN)    //生效的角色
                                            .role(RoleConstants.ROLE.ORGADMIN)
                            )
                            .permission(
                                    //创建用户
                                    new Permission.Builder()
                                            .require(OPERATE.READ)      //该权限的基础权限
                                            .operate(OPERATE.CREATE)    //权限操作
                                            .name("i18n_permission_user_create")
                                            .role(RoleConstants.ROLE.ADMIN)    //生效的角色
                                            .role(RoleConstants.ROLE.ORGADMIN)
                            )
                            
                    //...
            )
            .group(
                    //权限管理
                    new PermissionGroup.Builder()
                            .id(GROUP.ROLE)    //权限组
                            .name("i18n_permission_role")
                            .permission(
                                    new Permission.Builder()
                                            .operate(OPERATE.READ)
                                            .name("i18n_permission_role_read")
                                            .role(RoleConstants.ROLE.ADMIN)
                                            .role(RoleConstants.ROLE.ORGADMIN)
                            )
            )
            //...
            ;


```

***2. 后端权限限制***

支持以下几种方式：
```java
/**
 * 当前模块内的权限判断，第一个参数是权限组group，第二个参数是权限操作operate
 */
@PreAuthorize("hasCePermission('USER', 'READ')")
public void mMethod() {
        //...
}

/**
 * 推荐！
 * 当前模块内的权限判断，参数为权限组与操作的组合: "group:operate"
 */
@PreAuthorize("hasCePermission('USER:READ')")
public void mMethod() {
        //...
}

/**
 * 推荐！
 * 在上面的基础上支持匹配多个权限
 */
@PreAuthorize("hasAnyCePermission('USER:READ')")
public void mMethod() {
        //...
}

/**
 * security默认的方法
 * 需要带上模块名称 "[module_name]group:require+operate" 或 "[module_name]group:operate"
 */
@PreAuthorize("hasAuthority('[management-center]USER:READ+CREATE')")
public void mMethod() {
        //...
}

/**
 * security默认的方法
 * 在上面的基础上支持匹配多个权限
 */
@PreAuthorize("hasAnyAuthority('[management-center]USER:READ+CREATE')")
public void mMethod() {
        //...
}


```

实现源码见`CeSecurityExpressionRoot.java`

### 前端权限

***1. html代码中***
```html
<!--
    这里必须使用带模块名的权限格式
    "[module_name]group:require+operate" 或 "[module_name]group:operate"
-->

<div v-hasPermission="'[management-center]USER:READ+CREATE'"></div>


<!-- 也支持数组判断，只要有一个符合就显示 -->

<div v-hasPermission="['[management-center]USER:READ+CREATE','[management-center]USER:READ+EDIT']"></div>

```

***2. ts代码中***
```ts
import { usePermissionStore } from "@commons/stores/modules/permission";
const permissionStore = usePermissionStore();

/**
 * 以下方法的返回值即为是否有权限 
 * 这里必须使用带模块名的权限格式
 * "[module_name]group:require+operate" 或 "[module_name]group:operate"
 */
permissionStore.hasPermission("[vm-service]CLOUD_SERVER:STOP")

/**
 * 也支持数组判断，只要有一个符合就返回true
 */
permissionStore.hasPermission(["[vm-service]CLOUD_SERVER:START", "[vm-service]CLOUD_SERVER:STOP"])

```

### 新模块搭建
· 打开目录`demo/src/test/java/`下文件 [CreateModuleUtil.java](..%2Fdemo%2Fsrc%2Ftest%2Fjava%2FCreateModuleUtil.java)

· 修改文件中以下字段为需要生成的新模块信息
```java
/**
 * 模块名
 */
private static final String NEW_MODULE_NAME = "sample-module";

/**
 * 模块显示名称
 */
private static final String NEW_MODULE_DISPLAY_NAME = "样例模块";

/**
 * 模块显示名称（繁体）
 */
private static final String NEW_MODULE_DISPLAY_NAME_TW = "樣例模塊";

/**
 * 模块显示名称（英文）
 */
private static final String NEW_MODULE_DISPLAY_NAME_EN = "Sample Module";

/**
 * 后端服务端口
 */
private static final long NEW_MODULE_PORT = 9021;

/**
 * 开发时前端服务端口
 */
private static final long NEW_MODULE_FRONTEND_PORT = 5021;

/**
 * 服务管理端口
 */
private static final long NEW_MODULE_MANAGEMENT_PORT = 9921;
    
```
· 执行 createModule() 方法，等待执行完成，即会在services目录下根据模版创建出新的模块。

· 快速生成模块后，可根据需要再修改模块内的 `/模块名.yml` `/backend/src/main/resources/application.yml` 来修改该模块的icon以及菜单序号。

· 可按需修改模块内的`/backend/src/main/java/com/fit2cloud/ModuleApplication.java`文件名为自己想要的名字。

· 开发你的模块
